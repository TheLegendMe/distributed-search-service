worker_processes auto;
error_log /tmp/nginx_error.log;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # MIME 类型
    types {
        text/html                             html htm shtml;
        text/css                              css;
        text/xml                              xml;
        application/javascript                js;
        application/json                      json;
        image/gif                             gif;
        image/jpeg                            jpeg jpg;
        image/png                             png;
        image/svg+xml                         svg svgz;
    }
    
    default_type application/octet-stream;
    
    access_log /tmp/nginx_access.log;
    client_body_temp_path /tmp/client_body_temp;
    proxy_temp_path /tmp/proxy_temp;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;
    
    # 搜索服务
    upstream search_backend {
        server 127.0.0.1:8081;
    }
    
    # 推荐服务
    upstream recommend_backend {
        server 127.0.0.1:8082;
    }
    
    # 文件服务
    upstream file_backend {
        server 127.0.0.1:8083;
    }
    
    # 多模态搜索服务
    upstream multimodal_backend {
        server 127.0.0.1:8084;
    }
    
    # HTTP服务器（端口9999）
    server {
        listen 9999;
        server_name _;
        
        # 首页
        location / {
            root /home/oym/new/distributed-search-service/static;
            index index.html;
        }
        
        # 静态文件
        location /static/ {
            alias /home/oym/new/distributed-search-service/static/;
        }
        
        # 基础搜索API（精确匹配）
        location = /api/search {
            proxy_pass http://search_backend/search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
        }
        
        # 动态索引管理API
        location ~ ^/api/search/index/(.*)$ {
            proxy_pass http://search_backend/index/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header Access-Control-Allow-Origin "*" always;
            client_max_body_size 10M;
        }
        
        # 缓存管理API
        location ~ ^/api/search/cache/(.*)$ {
            proxy_pass http://search_backend/cache/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
        }
        
        # 推荐API
        location /api/recommend {
            proxy_pass http://recommend_backend/recommend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
        }
        
        # 文件服务API
        location /api/file/ {
            proxy_pass http://file_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
            
            # 文件上传需要更大的限制
            client_max_body_size 1000M;
            client_body_buffer_size 10M;
            proxy_request_buffering off;
        }
        
        # 多模态搜索API
        location /api/multimodal/ {
            proxy_pass http://multimodal_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
            
            # 支持较大的请求（图片上传）
            client_max_body_size 50M;
        }
        
        # 健康检查
        location /api/health {
            return 200 '{"status":"ok","service":"nginx"}';
            add_header Content-Type application/json;
        }
    }

    # HTTPS服务器（端口9443） - 支持crypto.subtle API
    server {
        listen 9443 ssl;
        server_name _;
        
        # SSL证书配置
        ssl_certificate /home/oym/new/distributed-search-service/ssl/server.crt;
        ssl_certificate_key /home/oym/new/distributed-search-service/ssl/server.key;
        
        # SSL优化
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        
        # 首页
        location / {
            root /home/oym/new/distributed-search-service/static;
            index index.html;
        }
        
        # 静态文件
        location /static/ {
            alias /home/oym/new/distributed-search-service/static/;
        }
        
        # 基础搜索API（精确匹配）
        location = /api/search {
            proxy_pass http://search_backend/search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
        }
        
        # 动态索引管理API
        location ~ ^/api/search/index/(.*)$ {
            proxy_pass http://search_backend/index/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header Access-Control-Allow-Origin "*" always;
            client_max_body_size 10M;
        }
        
        # 缓存管理API
        location ~ ^/api/search/cache/(.*)$ {
            proxy_pass http://search_backend/cache/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
        }
        
        # 推荐API
        location /api/recommend {
            proxy_pass http://recommend_backend/recommend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
        }
        
        # 文件服务API
        location /api/file/ {
            proxy_pass http://file_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
            
            # 文件上传需要更大的限制
            client_max_body_size 1000M;
            client_body_buffer_size 10M;
            proxy_request_buffering off;
        }
        
        # 多模态搜索API（HTTPS）
        location /api/multimodal/ {
            proxy_pass http://multimodal_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header Access-Control-Allow-Origin "*" always;
            client_max_body_size 50M;
        }
        
        # 健康检查
        location /api/health {
            return 200 '{"status":"ok","service":"nginx-https"}';
            add_header Content-Type application/json;
        }
    }
}
